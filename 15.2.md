# Домашнее задание к занятию «Вычислительные мощности. Балансировщики нагрузки»  

### Подготовка к выполнению задания

1. Домашнее задание состоит из обязательной части, которую нужно выполнить на провайдере Yandex Cloud, и дополнительной части в AWS (выполняется по желанию). 
2. Все домашние задания в блоке 15 связаны друг с другом и в конце представляют пример законченной инфраструктуры.  
3. Все задания нужно выполнить с помощью Terraform. Результатом выполненного домашнего задания будет код в репозитории. 
4. Перед началом работы настройте доступ к облачным ресурсам из Terraform, используя материалы прошлых лекций и домашних заданий.

---
## Задание 1. Yandex Cloud 

[Итоговый Terraform main.tf](https://github.com/joos-net/clopro-homeworks/blob/main/15.2-main.tf)

**Что нужно сделать**

1. Создать бакет Object Storage и разместить в нём файл с картинкой:

 - Создать бакет в Object Storage с произвольным именем (например, _имя_студента_дата_).
 - Положить в бакет файл с картинкой.
![1](https://github.com/joos-net/clopro-homeworks/blob/main/img2/1.png)
 - Сделать файл доступным из интернета.

![2](https://github.com/joos-net/clopro-homeworks/blob/main/img2/2.png)
```tf
## Создание бакета с использованием ключа
resource "yandex_storage_bucket" "test" {
  access_key = yandex_iam_service_account_static_access_key.sa-static-key.access_key
  secret_key = yandex_iam_service_account_static_access_key.sa-static-key.secret_key
  bucket     = local.bucket_name
  acl = "public-read"
  website {
    index_document = local.index
  }
}
## Копируем индекс с правилной кодировкой
resource "yandex_storage_object" "index" {
  access_key = yandex_iam_service_account_static_access_key.sa-static-key.access_key
  secret_key = yandex_iam_service_account_static_access_key.sa-static-key.secret_key
  acl = "public-read"
  bucket     = yandex_storage_bucket.test.id
  key        = local.index
  #source     = "site/${local.index}"
  content_base64 = base64encode(local.index_template)
  content_type = "text/html"
}
## Копируем картинки
resource "yandex_storage_object" "img" {
  access_key = yandex_iam_service_account_static_access_key.sa-static-key.access_key
  secret_key = yandex_iam_service_account_static_access_key.sa-static-key.secret_key
  acl        = "public-read"
  bucket     = yandex_storage_bucket.test.id
  key        = each.key
  source     = "site/${each.key}"
  for_each   = fileset("site", "img/*")
}
locals {
  index_template = templatefile("site/${local.index}.tpl", {
    endpoint = yandex_storage_bucket.test.website_endpoint
  })
}
```
2. Создать группу ВМ в public подсети фиксированного размера с шаблоном LAMP и веб-страницей, содержащей ссылку на картинку из бакета:

 - Создать Instance Group с тремя ВМ и шаблоном LAMP. Для LAMP рекомендуется использовать `image_id = fd827b91d99psvq5fjit`.

![3](https://github.com/joos-net/clopro-homeworks/blob/main/img2/3.png)
 - Для создания стартовой веб-страницы рекомендуется использовать раздел `user_data` в [meta_data](https://cloud.yandex.ru/docs/compute/concepts/vm-metadata).
 - Разместить в стартовой веб-странице шаблонной ВМ ссылку на картинку из бакета.
```sh
cat << 'EOF' > /var/www/html/index.html
<html>
<head>
    <title>My first page</title>
</head>
<body>
    <h1>Hello!</h1>
    <p><img src="https://storage.yandexcloud.net/tf-intro-site-bucket-1/img/cat1.jpg"></p>
    Homework Netology
</body>
</html>
EOF
echo " " >> /var/www/html/index.html
echo Instance: $(hostname) >> /var/www/html/index.html
```
 - Настроить проверку состояния ВМ.

![4](https://github.com/joos-net/clopro-homeworks/blob/main/img2/4.png)
```tf
resource "yandex_compute_instance_group" "ig-1" {
  name                  = "fixed-ig-with-balancer"
  folder_id             = local.folder_id
  service_account_id    = "${yandex_iam_service_account.ig-sa.id}"
  depends_on            = [yandex_resourcemanager_folder_iam_member.editor]
  
  instance_template {
    name        = "web{instance.index}"
    hostname    = "web{instance.index}"
    platform_id = "standard-v3"
    resources {
      core_fraction = 20
      memory = 2
      cores  = 2
    }
    boot_disk {
      mode = "READ_WRITE"
      initialize_params {
        image_id = "fd827b91d99psvq5fjit"
      }
    }

    network_interface {
      network_id = "${yandex_vpc_network.network-1.id}"
      subnet_ids = ["${yandex_vpc_subnet.internal-1.id}", "${yandex_vpc_subnet.internal-2.id}"]
    }

    metadata = {
      user-data = "${file("./init.sh")}"
    }
  }

  scale_policy {
    fixed_scale {
      size = 3
    }
  }

  allocation_policy {
    zones = ["ru-central1-a", "ru-central1-b"]
  }

  deploy_policy {
    max_unavailable = 1
    max_expansion   = 0
  }
### for load balancer
  load_balancer {
    target_group_name        = "target-group"
    target_group_description = "load balancer target group"
  }
### for application load balancer  
#   application_load_balancer {
#     target_group_name        = "target-group"
#     target_group_description = "Network Load Balancer target group"
#   }
}
```
3. Подключить группу к сетевому балансировщику:

 - Создать сетевой балансировщик.

![5](https://github.com/joos-net/clopro-homeworks/blob/main/img2/6.png)
 - Проверить работоспособность, удалив одну или несколько ВМ.

![7](https://github.com/joos-net/clopro-homeworks/blob/main/img2/7.png)
![8](https://github.com/joos-net/clopro-homeworks/blob/main/img2/8.png)
![9](https://github.com/joos-net/clopro-homeworks/blob/main/img2/9.png)
```tf
# Load Balancer
resource "yandex_lb_network_load_balancer" "lb-1" {
  name = "network-load-balancer-1"

  listener {
    name = "network-load-balancer-1-listener"
    port = 80
    external_address_spec {
      ip_version = "ipv4"
    }
  }

  attached_target_group {
    target_group_id = yandex_compute_instance_group.ig-1.load_balancer.0.target_group_id

    healthcheck {
      name = "http"
      http_options {
        port = 80
        path = "/index.html"
      }
    }
  }
}
```
4. (дополнительно)* Создать Application Load Balancer с использованием Instance group и проверкой состояния.
![10](https://github.com/joos-net/clopro-homeworks/blob/main/img2/10.png)
![11](https://github.com/joos-net/clopro-homeworks/blob/main/img2/11.png)
![12](https://github.com/joos-net/clopro-homeworks/blob/main/img2/12.png)
```tf
# Backend group
resource "yandex_alb_backend_group" "web-backend" {
  name                     = "web-backend"
  session_affinity {
    connection {
      source_ip = false
    }
  }

  http_backend {
    name                   = "my-web-backend"
    weight                 = 1
    port                   = 80
    target_group_ids       = [yandex_compute_instance_group.ig-1.application_load_balancer.0.target_group_id]
    load_balancing_config {
      panic_threshold      = 90
    }    
    healthcheck {
      timeout              = "10s"
      interval             = "2s"
      healthy_threshold    = 10
      unhealthy_threshold  = 15 
      http_healthcheck {
        path               = "/"
      }
    }
  }
}

# HTTP-router
resource "yandex_alb_http_router" "web-router" {
  name          = "web-router"
} 

resource "yandex_alb_virtual_host" "my-virtual-host" {
  name                    = "web-virt"
  http_router_id          = yandex_alb_http_router.web-router.id
  route {
    name                  = "web-route"
    http_route {
      http_route_action {
        backend_group_id  = yandex_alb_backend_group.web-backend.id
        timeout           = "60s"
      }
    }
  }
}    

#Load balancer
resource "yandex_alb_load_balancer" "web-balancer" {
  name        = "web-balancer"
  network_id  = yandex_vpc_network.network-1.id
  security_group_ids = []

  allocation_policy {
    location {
      zone_id   = "ru-central1-b"
      subnet_id = yandex_vpc_subnet.internal-2.id
    }
  }

  listener {
    name = "listener-http"
    endpoint {
      address {
        external_ipv4_address { 
          address = yandex_vpc_address.static.external_ipv4_address[0].address
        }
      }
      ports = [ 80 ]
    }
    http {
      handler {
        http_router_id = yandex_alb_http_router.web-router.id
      }
    }
  }
} 
```
Полезные документы:

- [Compute instance group](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/compute_instance_group).
- [Network Load Balancer](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/lb_network_load_balancer).
- [Группа ВМ с сетевым балансировщиком](https://cloud.yandex.ru/docs/compute/operations/instance-groups/create-with-balancer).

---
## Задание 2*. AWS (задание со звёздочкой)

Это необязательное задание. Его выполнение не влияет на получение зачёта по домашней работе.

**Что нужно сделать**

Используя конфигурации, выполненные в домашнем задании из предыдущего занятия, добавить к Production like сети Autoscaling group из трёх EC2-инстансов с  автоматической установкой веб-сервера в private домен.

1. Создать бакет S3 и разместить в нём файл с картинкой:

 - Создать бакет в S3 с произвольным именем (например, _имя_студента_дата_).
 - Положить в бакет файл с картинкой.
 - Сделать доступным из интернета.
2. Сделать Launch configurations с использованием bootstrap-скрипта с созданием веб-страницы, на которой будет ссылка на картинку в S3. 
3. Загрузить три ЕС2-инстанса и настроить LB с помощью Autoscaling Group.

Resource Terraform:

- [S3 bucket](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket)
- [Launch Template](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template).
- [Autoscaling group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group).
- [Launch configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_configuration).

Пример bootstrap-скрипта:

```
#!/bin/bash
yum install httpd -y
service httpd start
chkconfig httpd on
cd /var/www/html
echo "<html><h1>My cool web-server</h1></html>" > index.html
```
### Правила приёма работы

Домашняя работа оформляется в своём Git репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
Файл README.md должен содержать скриншоты вывода необходимых команд, а также скриншоты результатов.
Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.
